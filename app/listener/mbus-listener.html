<html>
	<head>
    	<meta charset="utf-8"></meta>
		<title>org.mbus.listener</title>
		<script src="../../src/client/MBusClient.js"></script> 
	</head>

	<body>
	 	<script language="javascript" type="text/javascript">
			var output;

			var url;
	  		var mbc;
			var timer;

			timer = null;

			function init()
			{
				output = document.getElementById("output");
			
				mbc = new MBusClient();
			
				mbc.onConnected = function () {
					mbc.subscribe(MBUS_SERVER_NAME, MBUS_METHOD_STATUS_IDENTIFIER_ALL, function (source, event, payload) {
						console.log(source + '.' + event, JSON.stringify(payload, null, '\t'));
						writeToScreen(source + '.' + event + ':' + JSON.stringify(payload));
					})
					
					mbc.subscribe(MBUS_METHOD_EVENT_SOURCE_ALL, MBUS_METHOD_EVENT_IDENTIFIER_ALL, function (source, event, payload) {
						console.log(source + '.' + event, JSON.stringify(payload, null, '\t'));
						writeToScreen(source + '.' + event + ':' + JSON.stringify(payload));
					})
				};

				mbc.onDisconnected = function () {
					if (timer !== null) {
						clearTimeout(timer);
					}
					timer = setTimeout(function () {
						console.log("connecting to: " + url);
						mbc.connect(url);
					}, 2000 + Math.floor(Math.random() * 2000));
				}
			 
				if (typeof window.location.hostname !== 'string' ||
				    window.location.hostname === '') {
					url = "ws://localhost:9000";
				} else {
					url = "ws://" + window.location.hostname + ":9000";
				}
				
				console.log("connecting to: " + url);
				mbc.connect(url);
			}
		
			function writeToScreen(message)
			{
				var pre = document.createElement("p");
				pre.style.wordWrap = "break-word";
				pre.innerHTML = message;
				output.appendChild(pre);
			}
		
			window.addEventListener("load", init, false);
		</script>
		
		<h2>org.mbus.listener</h2>
		
    		<div id="output"></div>
	</body>
</html>
